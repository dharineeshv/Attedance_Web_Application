<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Custom Date Input</title>
    <style>
      body {
        background: #f4f4f4;
        font-family: Arial, sans-serif;
      }
      input[type="date"] {
        position: relative;
        padding: 10px;
        border: 2px solid #ccc;
        border-radius: 8px;
        font-size: 16px;
        outline: none;
        transition: 0.3s;
        background-color: white;
      }
      /* Hide the default calendar icon */
      input[type="date"]::-webkit-calendar-picker-indicator {
        cursor: pointer;
      }
      /* Optional: custom styling for focus */
      input[type="date"]:focus {
        border-color: #4caf50;
      }
      input {
        width: 80vw;
        text-align: center;
      }
      * {
        padding: 0;
        margin: 0;
      }
      .form {
        display: flex;
        justify-content: space-around;
        padding: 10px;
      }
      .container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        justify-content: center;
        align-items: center;
      }
      .box {
        width: 80vw;
        border: 2px solid #ccc;
        padding: 10px;
        border-radius: 10px;
        display: grid;
        grid-template-columns: 1fr auto; /* text left, button right */
        align-items: center;
        background-color: white;
        gap: 10px;
      }

      button {
        padding: 8px;
        width: 100px;
        border: none;
        color: white;
        background-color: rgba(250, 5, 5, 0.832);
        border-radius: 10px;
      }
      h2 {
        text-align: center;
        padding: 2px;
      }
      .down {
        height: 1px;
        background-color: rgba(0, 0, 0, 0.1); /* soft gray line */
        width: 100%;
        grid-column: 1 / -1; /* make it span across the full grid width */
        margin-top: 15px; /* spacing above */
      }
      .status {
        display: flex;
        justify-content: space-between; /* left and right on same row */
        align-items: center;
        grid-column: 1 / -1; /* make it span full width in grid */
        margin-top: 10px;
        font-size: 14px;
        color: #333;
      }

      .left,
      .right {
        display: flex;
        align-items: center;
        gap: 5px; /* space between label and value */
      }

      .right b {
        color: #333;
      }

      .left b {
        color: #333;
      }
    </style>
  </head>
  <body>
    <h2>My Attendance</h2>
    <div class="form">
      <input type="date" id="dateInput" />
    </div>
    <div class="container">
      <!-- Box 1 -->
      <div class="box" id="box1">
        <b>08:45 am to 09:35 am</b>
        <button id="btn1">Absent</button>
        <div class="down"></div>
        <div class="status">
          <div class="left">
            <p>Marked by:</p>
            <b id="name1"></b>
          </div>
          <div class="right">
            <p>Time:</p>
            <b id="time1"></b>
          </div>
        </div>
      </div>

      <!-- Box 2 -->
      <div class="box" id="box2">
        <b>09:35 am to 10:25 am</b>
        <button id="btn2">Absent</button>
        <div class="down"></div>
        <div class="status">
          <div class="left">
            <p>Marked by:</p>
            <b id="name2"></b>
          </div>
          <div class="right">
            <p>Time:</p>
            <b id="time2"></b>
          </div>
        </div>
      </div>

      <!-- Box 3 -->
      <div class="box" id="box3">
        <b>10:40 am to 11:30 am</b>
        <button id="btn3">Absent</button>
        <div class="down"></div>
        <div class="status">
          <div class="left">
            <p>Marked by:</p>
            <b id="name3"></b>
          </div>
          <div class="right">
            <p>Time:</p>
            <b id="time3"></b>
          </div>
        </div>
      </div>

      <!-- Box 4 -->
      <div class="box" id="box4">
        <b>11:30 am to 12:20 pm</b>
        <button id="btn4">Absent</button>
        <div class="down"></div>
        <div class="status">
          <div class="left">
            <p>Marked by:</p>
            <b id="name4"></b>
          </div>
          <div class="right">
            <p>Time:</p>
            <b id="time4"></b>
          </div>
        </div>
      </div>

      <!-- Box 5 -->
      <div class="box" id="box5">
        <b>01:30 pm to 02:20 pm</b>
        <button id="btn5">Absent</button>
        <div class="down"></div>
        <div class="status">
          <div class="left">
            <p>Marked by:</p>
            <b id="name5"></b>
          </div>
          <div class="right">
            <p>Time:</p>
            <b id="time5"></b>
          </div>
        </div>
      </div>

      <!-- Box 6 -->
      <div class="box" id="box6">
        <b>02:20 pm to 03:10 pm</b>
        <button id="btn6">Absent</button>
        <div class="down"></div>
        <div class="status">
          <div class="left">
            <p>Marked by:</p>
            <b id="name6"></b>
          </div>
          <div class="right">
            <p>Time:</p>
            <b id="time6"></b>
          </div>
        </div>
      </div>

      <!-- Box 7 -->
      <div class="box" id="box7">
        <b>03:25 pm to 04:25 pm</b>
        <button id="btn7">Absent</button>
        <div class="down"></div>
        <div class="status">
          <div class="left">
            <p>Marked by:</p>
            <b id="name7"></b>
          </div>
          <div class="right">
            <p>Time:</p>
            <b id="time7"></b>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import {
    getDatabase,
    ref,
    set,
    onValue,
    get,
    push,
    update
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
console.log("ðŸ”¥ script loaded");

  const appSetting = {
    databaseURL: "https://attendance-application-ead94-default-rtdb.firebaseio.com/",
  };
  const app = initializeApp(appSetting);
  const database = getDatabase(app);

  //________________________________________________________
  //databases (student OTP table, per-date attendance under student_day_wise_details/<YYYY-MM-DD>)
  const student_otp_db = ref(database, "otp_by_student");
  const student_all_otp_details = ref(database, "student_day_wise_details");
  const teacher_otp_db = ref(database, "teachers_otp");
  //_________________________________________________________

  const dateInput = document.getElementById("dateInput");
  const teacher_email = sessionStorage.getItem("email");
  // accept either lowercase or capitalized session key depending on other pages
  const session_rollno = sessionStorage.getItem("rollno") || sessionStorage.getItem("Rollno") || null;

  // helper: format Date -> YYYY-MM-DD
  function formatDateYMD(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  // Set default date to today if empty
  const todayStr = formatDateYMD(new Date());
  if (dateInput && !dateInput.value) dateInput.value = todayStr;

  // initialize everything
  async function init() {
    let time = "";
    let teacher_otp = "";
    let studentOtp = "";
    let student_rollno = "";

    // Fetch teacher otp records (we'll build a map and prefer the one for this teacher_email if available)
    let teacherMap = {}; // otpKey -> { otp, createdAt, email }
    try {
      const snap = await get(teacher_otp_db);
      if (snap && snap.exists()) {
        const data = snap.val();
        for (let key in data) {
          const rec = data[key] || {};
          const o = (rec.otp || "").toString().trim();
          if (!o) continue;
          teacherMap[o] = { otp: o, createdAt: rec.createdAt || "", email: rec.email || "" };
        }
      }
      // If we have a teacher_email, try to use that exact record
      if (teacher_email) {
        for (const o in teacherMap) {
          if (teacherMap[o].email === teacher_email) {
            teacher_otp = teacherMap[o].otp;
            time = teacherMap[o].createdAt || "";
            break;
          }
        }
      }
    } catch (e) {
      console.error("Error reading teacher OTPs:", e);
    }

    // If a rollno is present in session (student logged in), use it.
    if (session_rollno) {
      student_rollno = session_rollno;
    }

    // Fetch student OTPs and build a map so we can match by OTP if needed
    let studentMap = {}; // otp -> { rollno, otp, time, date }
    try {
      const snap2 = await get(student_otp_db);
      if (snap2 && snap2.exists()) {
        const data = snap2.val();
        for (let key in data) {
          const rec = data[key] || {};
          const sOtpField = (rec.student_otp || rec.students_otp || "").toString().trim();
          if (!sOtpField) continue;
          // prefer the most recent if multiple entries have same otp (we can't know timestamp reliably here)
          studentMap[sOtpField] = { rollno: rec.rollno || "", otp: sOtpField, time: rec.time || rec.createdAt || "", date: rec.date || "" };
        }
      }
    } catch (e) {
      console.error("Error reading student OTPs:", e);
    }

    // If we don't yet have student_rollno, try to find a student matching the teacher_otp
    if (!student_rollno && teacher_otp) {
      const candidate = studentMap[teacher_otp];
      if (candidate) {
        student_rollno = candidate.rollno;
        studentOtp = candidate.otp;
      }
    }

    // If student_rollno provided but we don't have studentOtp, try to find any otp belonging to that rollno
    if (student_rollno && !studentOtp) {
      for (const o in studentMap) {
        if (studentMap[o].rollno === student_rollno) {
          studentOtp = studentMap[o].otp;
          break;
        }
      }
    }

    // (We already built studentMap above and attempted to populate studentOtp/rollno)

  // Debug logging: show the resolved values we will use for matching
  console.debug("init(): resolved -> teacher_email=", teacher_email, "teacher_otp=", teacher_otp, "student_rollno=", student_rollno, "studentOtp=", studentOtp, "time=", time);

    // Parse time into hours/minutes (24-hour)
    let hours = null,
      minutes = null;
    if (time) {
      const t = time.trim();
      // Accept '03:25 PM' or '03:25PM' or '3:25PM' or '15:25'
      const re = /^(\d{1,2}):(\d{2})\s*(AM|PM)?$/i;
      const m = t.match(re);
      if (m) {
        const hStr = m[1];
        const mStr = m[2];
        const ampm = m[3];
        hours = parseInt(hStr, 10);
        minutes = parseInt(mStr, 10);
        if (ampm) {
          if (/pm/i.test(ampm) && hours < 12) hours += 12;
          if (/am/i.test(ampm) && hours === 12) hours = 0;
        }
      } else {
        console.warn('Unrecognized time format from teachers_otp.createdAt:', time);
      }
    }

    // helper to check a time window (inclusive)
    function inRange(h, m, sh, sm, eh, em) {
      const val = h * 60 + m;
      const start = sh * 60 + sm;
      const end = eh * 60 + em;
      return val >= start && val <= end;
    }

    // Normalize OTPs for comparison
    const normalizedTeacherOtp = (teacher_otp || "").toString().trim();
    const normalizedStudentOtp = (studentOtp || "").toString().trim();

    // If teacher_otp matches a student and time available, mark the corresponding period
    if (normalizedTeacherOtp && hours !== null && minutes !== null) {
      if (normalizedStudentOtp === normalizedTeacherOtp) {
        const periods = [
          { id: 1, sh: 8, sm: 45, eh: 9, em: 35 },
          { id: 2, sh: 9, sm: 36, eh: 10, em: 25 },
          { id: 3, sh: 10, sm: 40, eh: 11, em: 30 },
          { id: 4, sh: 11, sm: 31, eh: 12, em: 20 },
          { id: 5, sh: 13, sm: 30, eh: 14, em: 20 },
          { id: 6, sh: 14, sm: 21, eh: 15, em: 10 },
          { id: 7, sh: 15, sm: 25, eh: 16, em: 25 },
        ];

        let matched = false;
        for (const p of periods) {
          if (inRange(hours, minutes, p.sh, p.sm, p.eh, p.em)) {
            console.debug(`auto mark period ${p.id}`);
            await markPresent(p.id, student_rollno);
            matched = true;
            break;
          }
        }

        if (!matched) {
          // fallback: choose nearest period by midpoint
          const cur = hours * 60 + minutes;
          let best = null;
          let bestDiff = Infinity;
          for (const p of periods) {
            const mid = ((p.sh * 60 + p.sm) + (p.eh * 60 + p.em)) / 2;
            const diff = Math.abs(cur - mid);
            if (diff < bestDiff) {
              bestDiff = diff;
              best = p.id;
            }
          }
          console.warn(`Time ${hours}:${String(minutes).padStart(2,'0')} didn't match any period; falling back to period ${best}`);
          if (best !== null) await markPresent(best, student_rollno);
        }
      } else {
        console.debug('teacher_otp does not match studentOtp; teacher_otp=', normalizedTeacherOtp, 'studentOtp=', normalizedStudentOtp);
      }
    }

    // Load attendance for the currently selected date
    const initialDate = dateInput && dateInput.value ? dateInput.value : todayStr;
    await loadAttendanceForDate(initialDate, student_rollno);

    // Listen for date changes
    if (dateInput) {
      dateInput.addEventListener("change", async () => {
        const selected = dateInput.value || todayStr;
        await loadAttendanceForDate(selected, student_rollno);
      });
    }
  }

  // Load attendance for a given date (YYYY-MM-DD) and rollno
  async function loadAttendanceForDate(dateStr, rollno) {
    // reset UI
    for (let i = 1; i <= 7; i++) {
      markAbsent(i);
      const nameEl = document.getElementById(`name${i}`);
      const timeEl = document.getElementById(`time${i}`);
      if (nameEl) nameEl.textContent = "";
      if (timeEl) timeEl.textContent = "";
    }

    if (!rollno) return;

    try {
      // Read the record at date/rollno directly
      const recRef = ref(database, `student_day_wise_details/${dateStr}/${rollno}`);
      const snap = await get(recRef);
      if (snap && snap.exists()) {
        const rec = snap.val();
        for (let p = 1; p <= 7; p++) {
          if (rec[`period${p}`] === true) {
            const btn = document.getElementById(`btn${p}`);
            if (btn) {
              btn.textContent = "Present";
              btn.style.backgroundColor = "green";
            }
            const nameEl = document.getElementById(`name${p}`);
            const timeEl = document.getElementById(`time${p}`);
            if (nameEl && rec.markedBy) nameEl.textContent = rec.markedBy;
            if (timeEl && rec.markedAt) timeEl.textContent = rec.markedAt;
          }
        }
      }
    } catch (e) {
      console.error("Error loading attendance for date", dateStr, e);
    }
  }

  // Mark present: updates UI and writes attendance under student_day_wise_details/<date>
  async function markPresent(periodNumber, rollno) {
    const btn = document.getElementById(`btn${periodNumber}`);
    if (btn) {
      btn.textContent = "Present";
      btn.style.backgroundColor = "green";
    }
    const nameEl = document.getElementById(`name${periodNumber}`);
    const timeEl = document.getElementById(`time${periodNumber}`);
    const markedBy = sessionStorage.getItem("teacherName") || sessionStorage.getItem("email") || "";
    const markedAt = new Date().toLocaleTimeString();
    if (nameEl) nameEl.textContent = markedBy;
    if (timeEl) timeEl.textContent = markedAt;

    if (!rollno) return; // cannot persist without roll number

    const dateStr = (dateInput && dateInput.value) ? dateInput.value : todayStr;
    try {
      // Write directly at date/rollno (simple and idempotent)
      const recRef = ref(database, `student_day_wise_details/${dateStr}/${rollno}`);
      const snap = await get(recRef);
      if (snap && snap.exists()) {
        const existing = snap.val();
        const updates = {
          ...existing,
          [`period${periodNumber}`]: true,
          markedBy,
          markedAt,
        };
        await set(recRef, updates);
      } else {
        const newRec = {
          rollno: rollno,
          period1: false,
          period2: false,
          period3: false,
          period4: false,
          period5: false,
          period6: false,
          period7: false,
          markedBy,
          markedAt,
        };
        newRec[`period${periodNumber}`] = true;
        await set(recRef, newRec);
      }
    } catch (e) {
      console.error("Error writing attendance:", e);
    }
  }

  function markAbsent(periodNumber) {
    const btn = document.getElementById(`btn${periodNumber}`);
    if (btn) {
      btn.textContent = "Absent";
      btn.style.backgroundColor = "rgba(250, 5, 5, 0.832)";
    }
    const nameEl = document.getElementById(`name${periodNumber}`);
    const timeEl = document.getElementById(`time${periodNumber}`);
    if (nameEl) nameEl.textContent = "";
    if (timeEl) timeEl.textContent = "";
  }

  // Start initialization
  init();
</script>

<script
  src="https://kit.fontawesome.com/6045d1d2eb.js"
  crossorigin="anonymous"
></script>

