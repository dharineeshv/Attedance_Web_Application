<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manual Attendance</title>
  <style>
    body {
      background: #f4f4f4;
      font-family: Arial, sans-serif;
    }
    input[type="date"] {
      position: relative;
      padding: 10px;
      border: 2px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      transition: 0.3s;
      background-color: white;
      width: 80vw;
      text-align: center;
    }
    input[type="date"]:focus {
      border-color: #4caf50;
    }
    * {
      padding: 0;
      margin: 0;
    }
    .form {
      display: flex;
      justify-content: center;
      padding: 10px;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      justify-content: center;
      align-items: center;
    }
    .box {
      width: 80vw;
      border: 2px solid #ccc;
      padding: 10px;
      border-radius: 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      background-color: white;
      gap: 10px;
      user-select: none;
    }
    button {
      padding: 8px;
      width: 100px;
      border: none;
      color: white;
      background-color: rgba(250, 5, 5, 0.832);
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
    }
    h2 {
      text-align: center;
      padding: 2px;
    }
    .down {
      height: 1px;
      background-color: rgba(0, 0, 0, 0.1);
      width: 100%;
      grid-column: 1 / -1;
      margin-top: 15px;
    }
    .status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      grid-column: 1 / -1;
      margin-top: 10px;
      font-size: 14px;
      color: #333;
    }
    .left, .right {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .right b, .left b {
      color: #333;
    }
  </style>
</head>
<body>
  <h2>My Attendance</h2>
  <div class="form">
    <input type="date" id="dateInput" />
  </div>
  <div class="container">
    <div class="box" id="box1">
      <b>08:45 am to 09:35 am</b>
      <button id="btn1">Absent</button>
      <div class="down"></div>
      <div class="status">
        <div class="left">
          <p>Marked by:</p>
          <b id="name1"></b>
        </div>
        <div class="right">
          <p>Time:</p>
          <b id="time1"></b>
        </div>
      </div>
    </div>
    <div class="box" id="box2">
      <b>09:35 am to 10:25 am</b>
      <button id="btn2">Absent</button>
      <div class="down"></div>
      <div class="status">
        <div class="left">
          <p>Marked by:</p>
          <b id="name2"></b>
        </div>
        <div class="right">
          <p>Time:</p>
          <b id="time2"></b>
        </div>
      </div>
    </div>
    <div class="box" id="box3">
      <b>10:40 am to 11:30 am</b>
      <button id="btn3">Absent</button>
      <div class="down"></div>
      <div class="status">
        <div class="left">
          <p>Marked by:</p>
          <b id="name3"></b>
        </div>
        <div class="right">
          <p>Time:</p>
          <b id="time3"></b>
        </div>
      </div>
    </div>
    <div class="box" id="box4">
      <b>11:30 am to 12:20 pm</b>
      <button id="btn4">Absent</button>
      <div class="down"></div>
      <div class="status">
        <div class="left">
          <p>Marked by:</p>
          <b id="name4"></b>
        </div>
        <div class="right">
          <p>Time:</p>
          <b id="time4"></b>
        </div>
      </div>
    </div>
    <div class="box" id="box5">
      <b>01:30 pm to 02:20 pm</b>
      <button id="btn5">Absent</button>
      <div class="down"></div>
      <div class="status">
        <div class="left">
          <p>Marked by:</p>
          <b id="name5"></b>
        </div>
        <div class="right">
          <p>Time:</p>
          <b id="time5"></b>
        </div>
      </div>
    </div>
    <div class="box" id="box6">
      <b>02:20 pm to 03:10 pm</b>
      <button id="btn6">Absent</button>
      <div class="down"></div>
      <div class="status">
        <div class="left">
          <p>Marked by:</p>
          <b id="name6"></b>
        </div>
        <div class="right">
          <p>Time:</p>
          <b id="time6"></b>
        </div>
      </div>
    </div>
    <div class="box" id="box7">
      <b>03:25 pm to 04:25 pm</b>
      <button id="btn7">Absent</button>
      <div class="down"></div>
      <div class="status">
        <div class="left">
          <p>Marked by:</p>
          <b id="name7"></b>
        </div>
        <div class="right">
          <p>Time:</p>
          <b id="time7"></b>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

    const appSetting = {
      databaseURL: "https://attendance-application-ead94-default-rtdb.firebaseio.com/",
    };

    const app = initializeApp(appSetting);
    const database = getDatabase(app);

    const student_all_otp_details = ref(database, "student_day_wise_details");

    // Retrieve from sessionStorage
    const teacher_email = sessionStorage.getItem("email") || "Teacher";
    const rollno = sessionStorage.getItem("Rollno") || "unknown";

    // Date input setup: default to today
    const dateInput = document.getElementById("dateInput");
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    dateInput.value = `${yyyy}-${mm}-${dd}`;

    // Convert yyyy-mm-dd to dd-mm-yyyy
    function formatDateToDDMMYYYY(isoDate) {
      const [yyyy, mm, dd] = isoDate.split("-");
      return `${dd}-${mm}-${yyyy}`;
    }

    // Mark Present function
    async function markPresent(boxNumber) {
      const now = new Date();
      const currentTime = now.toLocaleTimeString("en-US", {
        hour: "2-digit",
        minute: "2-digit",
        hour12: true,
      });

      const formattedDate = formatDateToDDMMYYYY(dateInput.value);

      const datas = {
        rollno: rollno,
        boxNumber: boxNumber,
        markedBy: teacher_email,
        time: currentTime,
        status: "Present",
        date: formattedDate,
      };

      const recordPath = `student_day_wise_details/${rollno}_${formattedDate}_${boxNumber}`;
      await set(ref(database, recordPath), datas);

      updateUI(boxNumber, "Present", teacher_email, currentTime);
    }

    // Mark Absent function
    async function markAbsent(boxNumber) {
      const formattedDate = formatDateToDDMMYYYY(dateInput.value);

      const datas = {
        rollno: rollno,
        boxNumber: boxNumber,
        markedBy: teacher_email,
        time: "",
        status: "Absent",
        date: formattedDate,
      };

      const recordPath = `student_day_wise_details/${rollno}_${formattedDate}_${boxNumber}`;
      await set(ref(database, recordPath), datas);

      updateUI(boxNumber, "Absent", "", "");
    }

    // Update UI helper
    function updateUI(boxNumber, status, markedBy, time) {
      const btn = document.getElementById(`btn${boxNumber}`);
      const nameField = document.getElementById(`name${boxNumber}`);
      const timeField = document.getElementById(`time${boxNumber}`);

      btn.textContent = status;
      btn.style.backgroundColor = status === "Present" ? "green" : "rgba(250, 5, 5, 0.832)";
      nameField.textContent = markedBy;
      timeField.textContent = time;
    }

    // Load attendance data for selected date
    async function loadAttendance() {
      const formattedDate = formatDateToDDMMYYYY(dateInput.value);

      // Clear all buttons first
      for (let i = 1; i <= 7; i++) {
        updateUI(i, "Absent", "", "");
      }

      const snapshot = await get(student_all_otp_details);
      const allData = snapshot.val() || {};

      for (const key in allData) {
        const entry = allData[key];
        if (entry.rollno === rollno && entry.date === formattedDate) {
          const boxNumber = entry.boxNumber;
          const status = entry.status;
          const markedBy = entry.markedBy;
          const time = entry.time;
          updateUI(boxNumber, status, markedBy, time);
        }
      }
    }

    // Add click event listeners to toggle attendance status
    for (let i = 1; i <= 7; i++) {
      const btn = document.getElementById(`btn${i}`);
      btn.addEventListener("click", () => {
        if (btn.textContent === "Absent") {
          markPresent(i);
        } else {
          markAbsent(i);
        }
      });
    }

    // When date changes, reload attendance
    dateInput.addEventListener("change", loadAttendance);

    // Initial load
    loadAttendance();
  </script>
</body>
</html>
